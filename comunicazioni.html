<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClasseViva - Comunicazioni</title>
    <style>
        /* RESET E FONT */
        body { font-family: 'Open Sans', Arial, sans-serif; margin: 0; padding: 0; background-color: #f7f7f7; color: #333; }
        
        /* COLORI CLASSEVIVA */
        :root {
            --cv-red: #d8232a;
            --cv-yellow: #ffcc00;
            --cv-green: #28a745;
            --cv-dark-red: #a01a20;
            --cv-blue: #007bff;
        }

        /* HEADER E NAVIGAZIONE */
        .header { background-color: var(--cv-red); color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-title { font-size: 1.5em; font-weight: bold; text-decoration: none; color: white; }
        .header-center { font-size: 1.1em; font-weight: 300; }
        .user-icon { background-color: rgba(255, 255, 255, 0.2); padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        .tab-bar { 
            background-color: #f0f0f0; 
            border-bottom: 1px solid #ddd; 
            display: flex; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .tab {
            padding: 10px 20px;
            font-size: 0.9em;
            color: #555;
            cursor: pointer;
            border-right: 1px solid #ddd;
            border-top: 3px solid transparent;
            transition: border-top 0.2s, background-color 0.2s;
        }
        .tab.active {
            font-weight: bold;
            color: var(--cv-red);
            background-color: white;
            border-top: 3px solid var(--cv-red);
            border-bottom: 1px solid white; 
        }

        .content { padding: 20px; max-width: 1200px; margin: 0 auto; }
        
        .main-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-top: 20px;
        }

        .main-content {
            min-height: 500px;
        }

        /* BOX "INFORMAZIONI E SONDAGGI" (A DESTRA) */
        .sidebar-box {
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .sidebar-box h4 {
            margin-top: 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
            font-size: 1em;
            color: #333;
        }
        .sidebar-box p {
            font-size: 0.9em;
            color: #777;
            text-align: center;
            padding: 20px 0;
        }

        /* PULSANTE AGGIUNGI NOTA (+) */
        .add-note-button {
            background-color: var(--cv-red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            line-height: 1;
            text-align: center;
            cursor: pointer;
            position: fixed;
            bottom: 30px;
            right: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: background-color 0.2s;
        }
        .add-note-button:hover {
            background-color: var(--cv-dark-red);
        }

        /* MODALE FORM (GIA' PRESENTE) */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); padding-top: 60px; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 600px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-button:hover, .close-button:focus { color: #333; text-decoration: none; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group select, .form-group textarea, .form-group input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        .radio-group label { margin-right: 15px; font-weight: normal; }
        .student-selection-box { border: 1px solid #ddd; padding: 10px; max-height: 150px; overflow-y: auto; background-color: #f9f9f9; border-radius: 4px; margin-top: 5px; }
        .student-selection-box label { display: block; margin-bottom: 3px; font-weight: normal; font-size: 0.85em; }
        .submit-btn { background-color: var(--cv-blue); color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .submit-btn:hover { background-color: #0056b3; }


        /* STILI CANCELLAZIONE NOTE */
        #notes-list { padding: 0; list-style: none; }
        .note-card {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            background-color: #fcfcfc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer; /* Indica che √® cliccabile */
            transition: background-color 0.1s;
        }
        .note-card:hover {
            background-color: #fff0f0; /* Evidenzia al passaggio o click */
        }
        .note-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; font-size: 0.9em; }
        .note-type { font-weight: bold; padding: 3px 8px; border-radius: 4px; color: white; }
        .note-type.disciplinare { background-color: var(--cv-red); }
        .note-type.semplice { background-color: var(--cv-blue); }
        .note-details { font-size: 0.8em; color: #777; }
        .note-comment { font-size: 1em; color: #333; margin-top: 10px; white-space: pre-wrap; }
        .note-comment strong { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        
        /* NUOVO MODALE DI CONFERMA CANCELLAZIONE */
        #deleteConfirmModal .modal-content {
            max-width: 400px;
            text-align: center;
        }
        #deleteConfirmModal button {
            margin: 5px;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #confirmDeleteBtn {
            background-color: var(--cv-red);
            color: white;
        }
        #cancelDeleteBtn {
            background-color: #ccc;
            color: #333;
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="registro_classe.html" class="header-title">CLASSEVIVA</a>
        <span class="header-center">Comunicazioni</span>
        <div class="user-icon">üë§</div>
    </div>
    
    <div class="tab-bar">
        <a href="registro_classe.html" class="icon-item icon-active"><div class="i-appello">üìñ</div>Appello</a>
            <a href="comunicazioni.html" class="icon-item"><div class="i-comunicazioni">üì¢</div>Comunicazioni</a>
            <a href="agenda_oggi.html" class="icon-item"><div class="i-agenda">üìÖ</div>Agenda di oggi</a>
            <a href="firma.html" class="icon-item"><div class="i-firma">‚úçÔ∏è</div>Firma</a>
            <a href="compresenza.html" class="icon-item"><div class="i-comprensenza">üë•</div>Comprensenza</a>
            <a href="assenze.html" class="icon-item"><div class="i-assenze">üö´</div>Assenze</a>
            <a href="valutazioni.html" class="icon-item"><div class="i-valutazioni">üíØ</div>Valutazioni</a>
            <a href="agenda.html" class="icon-item"><div class="i-agenda-prof">üóìÔ∏è</div>Agenda</a>
            <a href="didattica.html" class="icon-item"><div class="i-valutazioni">üíØ</div>Didattica</a>
            <a href="mie_classi.html" class="icon-item" id="classi-link"><div class="i-classi">üè´</div>Le mie classi</a>
            <a href="gruppi.html" class="icon-item"><div class="i-tutti">üåê</div>Tutti i gruppi</a>
    </div>

    <div class="content">
        <div class="main-container">
            <div class="main-content">
                <div class="sidebar-box" style="padding: 15px;">
                    <h2 style="margin-top: 0; font-size: 1.2em; color: var(--cv-red);">Note, Annotazioni e Comunicazioni di classe </h2>
                    <p style="font-size: 0.9em; text-align: left; padding: 5px 0; color: #555;">Clicca su una nota per l'opzione di cancellazione.</p>
                    <ul id="notes-list">
                        </ul>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="sidebar-box">
                    <h4>Informazioni e sondaggi</h4>
                    <p>Nessuna informazione / sondaggio disponibile</p>
                </div>
            </div>
        </div>
    </div>

    <button class="add-note-button" onclick="openModal('noteModal')">+</button>

    <div id="noteModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('noteModal')">&times;</span>
            <h2 id="modal-title">Nuova Nota</h2>
            <div class="form-group radio-group">
                <label>Tipo di Annotazione:</label>
                <input type="radio" id="nota-semplice" name="note_type" value="Nota" checked onchange="updateModalTitle()">
                <label for="nota-semplice">Nota (Semplice)</label>
                <input type="radio" id="nota-disciplinare" name="note_type" value="Nota Disciplinare" onchange="updateModalTitle()">
                <label for="nota-disciplinare">Nota Disciplinare</label>
                <input type="radio" id="Comunicazioni Istituto" name="note_type" value="Comunicazioni Istituto" onchange="updateModalTitle()">
                <label for="nota-disciplinare">Comunicazioni Istituto</label>
            </div>
            
            <div class="form-group">
                <label for="note-class">Seleziona Classe:</label>
                <select id="note-class" onchange="renderStudentCheckboxes()">
                </select>
            </div>

            <div class="form-group">
                <label>Seleziona Studente/i:</label>
                <div class="student-selection-box" id="student-checkboxes">
                    <p style="text-align: center; color: #999;">Seleziona una classe.</p>
                </div>
            </div>

            <div class="form-group">
                <label for="note-comment">Commento:</label>
                <textarea id="note-comment" rows="4" placeholder="Inserisci qui il commento..."></textarea>
            </div>

            <button class="submit-btn" onclick="saveNote()">Pubblica</button>
        </div>
    </div>

    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <h2>Conferma Cancellazione</h2>
            <p>Sei sicuro di voler **cancellare definitivamente** questa nota?</p>
            <button id="confirmDeleteBtn" onclick="deleteNote()">S√¨, Cancella</button>
            <button id="cancelDeleteBtn" onclick="closeModal('deleteConfirmModal')">Annulla</button>
        </div>
    </div>

    <script>
        // --- Dati di base (simulazione) ---
        const studentData = {
            '1A': [
                { id: 1, name: 'STELLINA DEMATTEIS' },
                { id: 2, name: 'PANDINO DEMATTEIS' },
                { id: 3, name: 'TARTARUGA BENUA' },
                { id: 4, name: 'YUCKY BENUA' },
                { id: 5, name: 'LOLLO BENUA' },
                { id: 6, name: 'BRICIOLA DEMATTEIS' },
                { id: 7, name: 'FLUFFY DEMATTEIS' },
                { id: 8, name: 'TINA DEMATTEIS' },
                { id: 9, name: 'GRIGETTA BENUA' },
                { id: 10, name: 'LUNA DEMATTEIS' },
            ],
            '2A': [
                { id: 11, name: 'CANE DEMATTEIS' },
                { id: 12, name: 'CANE BENUA' },
                { id: 13, name: 'MICIAN DEMATTEIS' },
            ],
            '3A': [
                { id: 14, name: 'ALPHA SCARLETTI' },
                { id: 15, name: 'BRAVO BIANCHI' },
                { id: 16, name: 'CHARLIE NERI' },
            ],
            '4A': [
                { id: 17, name: 'DELTA ROSSI' },
                { id: 18, name: 'ECHO VERDI' },
            ],
            '5A': [
                { id: 19, name: 'FOXTROT GIALLI' },
                { id: 20, name: 'GOLF GRIGI' },
            ]
        };
        const NOTES_STORAGE_KEY = 'cv_saved_notes';
        let noteIdToDelete = null; // Variabile per memorizzare l'ID della nota da eliminare

        // --- GESTIONE MODALE ---

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            if (modalId === 'noteModal') {
                // Resetta i campi all'apertura del modale Note
                document.getElementById('nota-semplice').checked = true;
                updateModalTitle();
                const selectElement = document.getElementById('note-class');
                if (selectElement.options.length > 0) {
                    selectElement.value = selectElement.options[0].value;
                }
                document.getElementById('note-comment').value = '';
                renderStudentCheckboxes();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // Resetta l'ID della nota da eliminare quando si chiude il modale di conferma
            if (modalId === 'deleteConfirmModal') {
                noteIdToDelete = null;
            }
        }

        function updateModalTitle() {
            const type = document.querySelector('input[name="note_type"]:checked').value;
            document.getElementById('modal-title').textContent = `Nuova ${type}`;
        }
        
        // Chiudi il modale se si clicca al di fuori
        window.onclick = function(event) {
            const noteModal = document.getElementById('noteModal');
            const deleteModal = document.getElementById('deleteConfirmModal');
            if (event.target == noteModal) {
                closeModal('noteModal');
            }
            if (event.target == deleteModal) {
                closeModal('deleteConfirmModal');
            }
        }

        // --- GESTIONE DATI CLASSE/STUDENTI ---

        function initializeClassSelect() {
            const select = document.getElementById('note-class');
            select.innerHTML = '';
            const classes = Object.keys(studentData);
            
            classes.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                select.appendChild(option);
            });
            
            renderStudentCheckboxes();
        }

        function renderStudentCheckboxes() {
            const classKey = document.getElementById('note-class').value;
            const container = document.getElementById('student-checkboxes');
            container.innerHTML = '';

            const students = studentData[classKey];
            if (!students || students.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999;">Nessun alunno trovato per questa classe.</p>';
                return;
            }

             const selectAllLabel = document.createElement('label');
             selectAllLabel.style.fontWeight = 'bold';
             selectAllLabel.style.borderBottom = '1px dashed #ccc';
             selectAllLabel.style.paddingBottom = '5px';
             selectAllLabel.innerHTML = `
                <input type="checkbox" id="select-all-students" onclick="toggleSelectAll(this)">
                SELEZIONA/DESELEZIONA TUTTI
             `;
             container.appendChild(selectAllLabel);


            students.forEach(student => {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" name="selected_students" value="${student.id}" data-name="${student.name}">
                    ${student.name}
                `;
                container.appendChild(label);
            });
        }
        
        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('#student-checkboxes input[name="selected_students"]');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
        }


        // --- SALVATAGGIO, CARICAMENTO E CANCELLAZIONE NOTE ---

        function getSavedNotes() {
            const notesJson = localStorage.getItem(NOTES_STORAGE_KEY);
            return notesJson ? JSON.parse(notesJson) : [];
        }

        function saveNote() {
            const type = document.querySelector('input[name="note_type"]:checked').value;
            const classKey = document.getElementById('note-class').value;
            const comment = document.getElementById('note-comment').value.trim();
            const selectedStudents = Array.from(document.querySelectorAll('input[name="selected_students"]:checked'))
                .filter(checkbox => checkbox.id !== 'select-all-students')
                .map(checkbox => ({ 
                    id: checkbox.value, 
                    name: checkbox.getAttribute('data-name') 
                }));

            if (selectedStudents.length === 0) {
                alert("Devi selezionare almeno uno studente.");
                return;
            }

            if (comment === "") {
                alert("Il commento non pu√≤ essere vuoto.");
                return;
            }

            const newNote = {
                id: Date.now(),
                type: type,
                class: classKey,
                students: selectedStudents,
                comment: comment,
                date: new Date().toLocaleString('it-IT')
            };

            const notes = getSavedNotes();
            notes.unshift(newNote);
            localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));

            renderNotesList();
            closeModal('noteModal');
        }

        // NUOVA FUNZIONE: Chiede conferma per l'eliminazione
        function confirmDeleteNote(noteID) {
            noteIdToDelete = noteID; // Memorizza l'ID della nota
            openModal('deleteConfirmModal');
        }

        // NUOVA FUNZIONE: Cancella la nota
        function deleteNote() {
            if (noteIdToDelete !== null) {
                let notes = getSavedNotes();
                // Filtra e crea un nuovo array senza la nota con l'ID memorizzato
                notes = notes.filter(note => note.id !== noteIdToDelete);
                
                localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
                
                closeModal('deleteConfirmModal');
                renderNotesList(); // Aggiorna la lista
            }
        }

        function renderNotesList() {
            const notes = getSavedNotes();
            const listContainer = document.getElementById('notes-list');
            listContainer.innerHTML = '';

            if (notes.length === 0) {
                listContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Nessuna nota inserita. Clicca il (+) in basso a destra per aggiungerne una.</p>';
                return;
            }

            notes.forEach(note => {
                const typeClass = note.type.includes('Disciplinare') ? 'disciplinare' : 'semplice';
                
                let studentNames = note.students.map(s => s.name.split(' ')[0]).slice(0, 3).join(', ');
                if (note.students.length > 3) {
                    studentNames += ` e altri ${note.students.length - 3}`;
                } else if (note.students.length > 1) {
                    studentNames = studentNames.replace(/,([^,]*)$/, ' e$1');
                } else if (note.students.length === 1) {
                    studentNames = note.students[0].name;
                }

                const listItem = document.createElement('li');
                listItem.className = 'note-card';
                // COLLEGA QUI L'EVENTO DI CLICK al click sinistro
                listItem.setAttribute('onclick', `confirmDeleteNote(${note.id})`);
                
                // Opzionale: per il click destro
                // listItem.setAttribute('oncontextmenu', `event.preventDefault(); confirmDeleteNote(${note.id})`);


                listItem.innerHTML = `
                    <div class="note-header">
                        <span class="note-type ${typeClass}">${note.type}</span>
                        <span class="note-details">
                            Classe: ${note.class} | 
                            Data: ${note.date}
                        </span>
                    </div>
                    <div>
                        <strong style="color: ${typeClass === 'disciplinare' ? 'var(--cv-red)' : 'var(--cv-blue)'};">
                            ${note.students.length > 1 ? 'Alunni' : 'Alunno'} coinvolti: ${studentNames}
                        </strong>
                        <div class="note-comment">${note.comment}</div>
                    </div>
                `;
                listContainer.appendChild(listItem);
            });
        }
        
        // --- INIZIALIZZAZIONE ---

        document.addEventListener('DOMContentLoaded', () => {
            initializeClassSelect();
            renderNotesList();
        });

        // Espone le funzioni globali
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.updateModalTitle = updateModalTitle;
        window.renderStudentCheckboxes = renderStudentCheckboxes;
        window.saveNote = saveNote;
        window.toggleSelectAll = toggleSelectAll;
        window.confirmDeleteNote = confirmDeleteNote; // Funzione appena aggiunta
        window.deleteNote = deleteNote; // Funzione appena aggiunta
    </script>
</body>
</html>
